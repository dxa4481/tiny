name: gds

on:
  push:
  workflow_dispatch:

jobs:
  gds:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install gdstk
          sudo apt-get update
          sudo apt-get install -y librsvg2-bin

      - name: Generate Silicon Art GDS
        run: |
          cd src
          python create_silicon_art.py --text "[default]\naws_access_key_id = AKIAX24QKKOLLIHNWPFY\naws_secret_access_key = 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\noutput = json\nregion = us-east-2" --font-size 3 --output ../gds
          ls -la ../gds/

      - name: Create PNG preview (fallback for custom_gds action)
        run: |
          # Create gds_render.png before custom_gds action runs
          # The custom_gds action will upload this if its own PNG rendering fails
          rsvg-convert -w 1024 -h 768 gds/preview.svg -o gds_render.png
          echo "Created fallback gds_render.png:"
          ls -la gds_render.png

      - name: Build with Custom GDS
        uses: TinyTapeout/tt-gds-action/custom_gds@tt10
        with:
          top_module: tt_um_silicon_art
          gds_path: gds/tt_um_silicon_art.gds
          lef_path: gds/tt_um_silicon_art.lef
          verilog_path: gds/tt_um_silicon_art.v

  viewer:
    needs: gds
    runs-on: ubuntu-24.04
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Deploy to GitHub Pages
        uses: TinyTapeout/tt-gds-action/viewer@tt10
